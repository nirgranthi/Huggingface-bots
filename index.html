<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HuggingFace Bot</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
        .container { border: 1px solid #ddd; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chat-box { border: 1px solid #eee; padding: 10px; height: 300px; overflow-y: scroll; margin: 10px 0; border-radius: 5px; background: #fafafa;}
        .controls { display: flex; gap: 5px; margin-top: 10px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        input[type="text"] { flex-grow: 1; }
        button { padding: 10px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        .msg { margin: 5px 0; padding: 8px; background: #fff; border: 1px solid #eee; border-radius: 4px; }
        img { max-width: 100%; border-radius: 5px; margin-top: 5px; }
        .api-section { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ”’ Secure HF Multi-Bot</h2>

    <div class="api-section">
        <label>Step 1: Enter HF API Token</label>
        <input type="password" id="apiKey" placeholder="hf_xxxxxxxx..." style="width: 96%; margin-top: 5px;">
    </div>
    
    <label>Step 2: Choose Mode</label>
    <select id="mode" style="width: 100%; margin-top: 5px;">
        <option value="chat">Text Chat (Llama-3)</option>
        <option value="image">Generate Image (FLUX)</option>
    </select>

    <div class="chat-box" id="chatBox">
        <div class="msg"><i>System: Please enter your API Key above to start.</i></div>
    </div>

    <div class="controls">
        <input type="text" id="userInput" placeholder="Type something..." />
        <button onclick="handleRequest()">Send</button>
    </div>
</div>

<script>
    async function handleRequest() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const input = document.getElementById('userInput');
        const chatBox = document.getElementById('chatBox');
        const mode = document.getElementById('mode').value;
        const prompt = input.value;

        if (!apiKey) {
            alert("Please enter your Hugging Face API Token first!");
            return;
        }
        if (!prompt) return;

        // UI Updates
        chatBox.innerHTML += `<div class="msg" style="background:#eef;"><b>You:</b> ${prompt}</div>`;
        input.value = "";
        chatBox.scrollTop = chatBox.scrollHeight; // Auto scroll
        
        const loadingId = "load_" + Date.now();
        chatBox.innerHTML += `<div class="msg" id="${loadingId}"><i>Generating...</i></div>`;

        try {
            if (mode === "chat") {
                // Using Llama-3-8B-Instruct
                const response = await queryHF("meta-llama/Meta-Llama-3-8B-Instruct", { 
                    inputs: prompt,
                    parameters: { max_new_tokens: 500, return_full_text: false } 
                }, apiKey);
                
                document.getElementById(loadingId).remove();
                
                // Handling different response structures
                let reply = "No response";
                if (Array.isArray(response) && response[0].generated_text) {
                    reply = response[0].generated_text;
                } else if (response.error) {
                    reply = `Error: ${response.error}`;
                }
                
                chatBox.innerHTML += `<div class="msg"><b>Bot:</b> ${reply}</div>`;
            
            } else if (mode === "image") {
                // Using FLUX.1-dev
                const blob = await queryImage("black-forest-labs/FLUX.1-dev", { inputs: prompt }, apiKey);
                document.getElementById(loadingId).remove();
                
                if (blob.type === "application/json") {
                    // Usually means error text instead of image
                    const text = await blob.text();
                    chatBox.innerHTML += `<div class="msg" style="color:red">Error: ${text}</div>`;
                } else {
                    const imgUrl = URL.createObjectURL(blob);
                    chatBox.innerHTML += `<div class="msg"><b>Bot:</b><br><img src="${imgUrl}" /></div>`;
                }
            }
        } catch (error) {
            console.error(error);
            document.getElementById(loadingId).innerText = "Error: Check Console";
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Generic Text Fetcher
    async function queryHF(model, data, token) {
        const response = await fetch(`https://api-inference.huggingface.co/models/${model}`, {
            headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
            method: "POST",
            body: JSON.stringify(data),
        });
        return await response.json();
    }

    // Generic Image Fetcher
    async function queryImage(model, data, token) {
        const response = await fetch(`https://api-inference.huggingface.co/models/${model}`, {
            headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
            method: "POST",
            body: JSON.stringify(data),
        });
        return await response.blob();
    }
</script>

</body>
</html>
